SRC     := $(shell find src -name "*.c")
BUILD_DIR := build
OBJS    := $(SRC:%.c=$(BUILD_DIR)/%.o)
CC = epiclang
CFLAGS  := -Wall -Wextra -Werror -I./include -I. -std=gnu17
OFLAGS  := -I./include -I. -Wall -Wextra -Werror -std=gnu17
DEBUG   := 0

ifeq ($(G3), 1)
    OFLAGS += -g3
endif

ifeq ($(DEBUG), 1)
	CFLAGS += -fsanitize=address
endif

LIBS_DIR := libs
LIBS_DIRS := $(shell [ -d $(LIBS_DIR) ] && find $(LIBS_DIR)/* \
-maxdepth 0 -type d 2>/dev/null || echo "")
LIBS    := $(wildcard $(LIBS_DIRS:%=%/*.a))
LIB_TIMESTAMP := $(BUILD_DIR)/libs.timestamp
LDFLAGS := $(addprefix -L, $(LIBS_DIRS)) -L.
LDLIBS := $(addprefix -l, $(patsubst lib%.a,%,$(notdir $(LIBS)))) -l$(NAME)

all: $(NAME)

$(NAME): $(OBJS) $(LIB_TIMESTAMP)
	ar rcs lib$(NAME).a $(OBJS)

debug:
	@$(MAKE) DEBUG=1 G3=1 run

g3:
	@$(MAKE) G3=1 run

$(BUILD_DIR)/%.o: %.c
	@mkdir -p $(dir $@)
	$(CC) $(OFLAGS) -c $< -o $@

clean:
	rm -rf $(BUILD_DIR)
	@for dir in $(LIBS_DIRS); do \
		$(MAKE) -C $$dir clean; \
	done

fclean: clean
	rm -f lib$(NAME).a $(NAME)
	@for dir in $(LIBS_DIRS); do \
		$(MAKE) -C $$dir fclean; \
	done

$(LIB_TIMESTAMP): $(LIBS_DIRS)
	@echo "Checking libraries..."
	@if [ -z "$(LIBS_DIRS)" ]; then \
		echo "No library directories were found."; \
	else \
	    for dir in $(LIBS_DIRS); do \
			lib=$$(find $$dir -name '*.a' | head -n 1); \
			if [ -z "$$lib" ]; then \
				echo "Building library in $$dir... "; \
				$(MAKE) -C $$dir; \
				echo "Done"; \
			else \
				echo "Library already exists in $$dir, skipping."; \
			fi; \
	    done; \
	fi;
	@touch $(LIB_TIMESTAMP)

re: fclean all

run: re
	@if [ -f "main.c" ]; then \
		if [ -f "lib$(NAME).a" ]; then \
			$(eval LIBS    := $(wildcard $(LIBS_DIRS:%=%/*.a))) \
			$(eval LDFLAGS := $(addprefix -L, $(LIBS_DIRS)) -L.) \
			$(eval LDLIBS  := $(addprefix -l, \
			    $(patsubst lib%.a,%,$(notdir $(LIBS))))) \
			$(CC) main.c -o $(NAME) $(CFLAGS) $(LDFLAGS) \
			    -l$(NAME) $(LDLIBS); \
			echo "Running $(NAME)..."; \
			./$(NAME); \
		else \
			echo "Library $(NAME) not found!"; \
		fi; \
	else \
		echo "No main.c file found in the root directory."; \
	fi;

.PHONY: all clean fclean re run debug
