SRC = $(shell find src -name "*.c") main.c

BUILD_DIR = build
OBJS = $(SRC:%.c=$(BUILD_DIR)/%.o)

CFLAGS = -Wall -Wextra -Werror
OFLAGS = -I./include -Wall -Wextra

DEBUG = 0

ifeq ($(DEBUG), 1)
	CFLAGS += -fsanitize=address
	OFLAGS += -g3
endif

LIBS_DIR = libs
LIBS_DIRS = $(shell [ -d $(LIBS_DIR) ] && find $(LIBS_DIR)/* \
-maxdepth 0 -type d 2>/dev/null || echo "")
LIBS = $(wildcard $(LIBS_DIRS:%=%/*.a))

LIB_TIMESTAMP = $(BUILD_DIR)/libs.timestamp

LDFLAGS = $(addprefix -L, $(LIBS_DIRS))  # Ajoute le chemin des librairies
LDLIBS = $(addprefix -l, $(patsubst lib%.a,%,$(notdir $(LIBS))))

all: $(NAME)

$(NAME): $(OBJS) $(LIB_TIMESTAMP)
	gcc $(OBJS) -o $(NAME) $(CFLAGS) $(LDFLAGS) $(LDLIBS)

debug:
	@$(MAKE) DEBUG=1 run

$(BUILD_DIR)/%.o: %.c
	@mkdir -p $(dir $@)
	gcc $(OFLAGS) -c $< -o $@

clean:
	@rm -rf $(BUILD_DIR)
	@for dir in $(LIBS_DIRS); do \
		$(MAKE) -C $$dir clean; \
	done

fclean: clean
	rm -f $(NAME)
	@for dir in $(LIBS_DIRS); do \
		$(MAKE) -C $$dir fclean; \
	done

$(LIB_TIMESTAMP): $(LIBS_DIRS)
	@echo "Checking libraries..."
	@if [ -z "$(LIBS_DIRS)" ]; then \
	    echo "No library directories were found."; \
	else \
	    for dir in $(LIBS_DIRS); do \
			lib=$$(find $$dir -name '*.a' | head -n 1); \
			if [ -z "$$lib" ]; then \
				echo -n "Building library in $$dir... "; \
				$(MAKE) -C $$dir; \
			else \
				echo "Library already exists in $$dir, skipping."; \
			fi; \
	    done; \
	fi;
	@touch $(LIB_TIMESTAMP)

re: fclean all

run: re
	@if [ -f "$(NAME)" ]; then \
	    echo "Running..."; \
		./$(NAME); \
	else \
	    echo "Executable $(NAME) not found!"; \
	fi;
